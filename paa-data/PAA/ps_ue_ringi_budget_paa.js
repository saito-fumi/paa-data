/**
 * @NApiVersion 2.x
 * @NScriptType UserEventScript
 * @NModuleScope SameAccount
 * @author Zhou Haotian	
 */
//NS_ó\éZ_êVãKue
define(['N/currentRecord','N/ui/message',																		
       		'N/ui/dialog',																
    		'N/runtime',																
    		'N/record',																
    		'N/url',																
    		'N/search',
    		'/SuiteScripts/PAA/ps_common_paa', 'N/error','N/ui/serverWidget'],

function(record,message, dialog, runtime, record, url, search,common,error,serverWidget) {
   
    /**
     * Function definition to be triggered before record is loaded.
     *
     * @param {Object} scriptContext
     * @param {Record} scriptContext.newRecord - New record
     * @param {string} scriptContext.type - Trigger type
     * @param {Form} scriptContext.form - Current form
     * @Since 2015.2
     */
    function beforeLoad(scriptContext) {
    	var form = scriptContext.form;
    	var currentRecord = scriptContext.newRecord;
    	var recordtype = currentRecord.type;
    	var type = scriptContext.type;
    	var executionContext = runtime.executionContext;
    	
    	var type = scriptContext.type;
		if(type == 'create'||type == 'copy'||type == 'edit'){
			var userObj = runtime.getCurrentUser();
			var role = userObj.role;
			//ä«óùé“ÇèúÇ≠
			if(role != '3' && role != '1265'  && 'USERINTERFACE' == executionContext){
				//20230905 changed by zhou 
				//Asana https://app.asana.com/0/inbox/1205106777277248/1205419716693344/1205420765889284
				var executionContext = runtime.executionContext;
				var errorMessage = "ä«óùé“ÉçÅ[Éãà»äOÇÃÉçÅ[ÉãÇ…ÇÕï“èWå†å¿Ç™Ç†ÇËÇ‹ÇπÇÒ";
				throw errorMessage;
			}
		}
    	if(runtime.executionContext != runtime.ContextType.CSV_IMPORT){
    		//CSVì±ì¸éû
    		log.debug('in CSV_IMPORT','before load')
    	 form.getField({id: 'custrecord_ns_new_account_num'}).updateDisplayType({displayType : serverWidget.FieldDisplayType.HIDDEN});
    	}
    	//changed by song add 23030813 start
    	try{
    		var currentForm = scriptContext.form;
    		//îÒï\é¶
    		var rbName = currentForm.getField({id: 'custrecord_ns_new_rb_name'});
    		var rbList = currentForm.getField({id: 'custrecord_ns_new_policy_list'});
    		rbName.updateDisplayType({displayType: serverWidget.FieldDisplayType.HIDDEN});
    		rbList.updateDisplayType({displayType: serverWidget.FieldDisplayType.HIDDEN});
    		
    		//20230819 add by zhou start
    		for(var m = 1 ; m < 13 ; m++){
        		//Xåéó\éZécäz
    			var budgetField = form.addField({
                    id: 'custpage_ns_new_budget_'+m,
                    label: m+'åéó\éZäzHidden',
                    type: serverWidget.FieldType.CURRENCY
       		    })
       		    if(runtime.executionContext != runtime.ContextType.CSV_IMPORT){
           	    budgetField.updateDisplayType({
                    displayType : serverWidget.FieldDisplayType.HIDDEN
                });
       		    }
    			var residualField = form.addField({
                    id: 'custpage_ns_new_budget_'+m+'_residual',
                    label: m+'åéó\éZécäzHidden',
                    type: serverWidget.FieldType.CURRENCY
       		    })
       		    if(runtime.executionContext != runtime.ContextType.CSV_IMPORT){
           	    residualField.updateDisplayType({
                    displayType : serverWidget.FieldDisplayType.HIDDEN
                });
       		    }
    			var currentBudget = currentRecord.getValue({fieldId: 'custrecord_ns_new_budget_'+m})
    			var currentResidual = currentRecord.getValue({fieldId: 'custrecord_ns_new_budget_'+m+'_residual'})
    	    	currentRecord.setValue({
    	            fieldId: 'custpage_ns_new_budget_'+m,
    	            value: defaultEmpty(currentBudget),
    	            ignoreFieldChange: true,
    	        });
    			currentRecord.setValue({
    	            fieldId: 'custpage_ns_new_budget_'+m+'_residual',
    	            value: defaultEmpty(currentResidual),
    	            ignoreFieldChange: true,
    	        });
    		}	
    		//20230819 add by zhou end
    		//20230813 add by zhou start
    		var oldField = form.addField({
                id: 'custpage_old_rs_name',
                label: 'NS_é{çÙãÊï™2å√Ç¢ÉeÉLÉXÉg',
                type: serverWidget.FieldType.TEXTAREA
   		    })
       	    oldField.updateDisplayType({
                displayType : serverWidget.FieldDisplayType.HIDDEN
            });
    		
    		 var typeField = form.addField({
                 id: 'custpage_type',
                 label: 'NS_âÊñ èÛë‘',
                 type: serverWidget.FieldType.TEXTAREA
    		 })
        	 typeField.updateDisplayType({
                 displayType : serverWidget.FieldDisplayType.HIDDEN
             });

             typeField.defaultValue = type
    		//20230813 add by zhou end
                     
           //changed by song add 23030814 start
           if(type == 'copy'){
        	   //8åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_8_residual',value: '',ignoreFieldChange: true,});
        	   //9åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_9_residual',value: '',ignoreFieldChange: true,});
        	   //10åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_10_residual',value: '',ignoreFieldChange: true,});
        	   //11åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_11_residual',value: '',ignoreFieldChange: true,});
        	   //12åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_12_residual',value: '',ignoreFieldChange: true,});
        	   //1åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_1_residual',value: '',ignoreFieldChange: true,});
        	   //2åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_2_residual',value: '',ignoreFieldChange: true,});
        	   //3åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_3_residual',value: '',ignoreFieldChange: true,});
        	   //4åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_4_residual',value: '',ignoreFieldChange: true,});
        	   //5åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_5_residual',value: '',ignoreFieldChange: true,});
        	   //6åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_6_residual',value: '',ignoreFieldChange: true,});
        	   //7åéó\éZécäz
    	       currentRecord.setValue({fieldId: 'custrecord_ns_new_budget_7_residual',value: '',ignoreFieldChange: true,});
           }  
           //changed by song add 23030814 end
		}catch(e){
			log.debug("e",e.message);
		}
    	//changed by song add 23030813 end
		
		
    }

    /**
	 * Function definition to be triggered before record is loaded.
	 * 
	 * @param {Object}
	 *            scriptContext
	 * @param {Record}
	 *            scriptContext.newRecord - New record
	 * @param {Record}
	 *            scriptContext.oldRecord - Old record
	 * @param {string}
	 *            scriptContext.type - Trigger type
	 * @Since 2015.2
	 */
    function beforeSubmit(scriptContext) {
    	var currentRecord = scriptContext.newRecord;
    	var oldRecord = scriptContext.oldRecord;
    	var type = scriptContext.type;
    	var isinactiveFlag = currentRecord.getValue({
            fieldId: 'isinactive'
        });//ñ≥å¯
    	log.debug('type '+type)
    	if(type == 'create'){
    		log.debug('in cppy or create')
			for(var m = 1 ; m < 13 ; m++){
	    		//Xåéó\éZécäz
				var newMonthBudget = currentRecord.getValue({fieldId: 'custrecord_ns_new_budget_'+m});     
				var currentResidual = currentRecord.getValue({fieldId: 'custrecord_ns_new_budget_'+m+'_residual'})
	        	if(!isEmpty(newMonthBudget) && isEmpty(currentResidual)){
	    	    	currentRecord.setValue({
	    	            fieldId: 'custrecord_ns_new_budget_'+m+'_residual',
	    	            value: newMonthBudget,
	    	            ignoreFieldChange: true,
	    	        });
	        	}
			}	
		}
    	
    	if(runtime.executionContext === runtime.ContextType.CSV_IMPORT){
    		//changed by song add 23030723 start
        	try{
        	//20230819 changed by zhou start
        		if(type == 'edit'){
        			for(var m = 1 ; m < 13 ; m++){
        	    		//Xåéó\éZécäz
        				var oldMonthBudget = oldRecord.getValue({fieldId: 'custrecord_ns_new_budget_'+m});
        				
        				var newMonthBudget = currentRecord.getValue({fieldId: 'custrecord_ns_new_budget_'+m});     
        				
        				var currentResidual = currentRecord.getValue({fieldId: 'custrecord_ns_new_budget_'+m+'_residual'})
        	        	if(!isEmpty(newMonthBudget) && oldMonthBudget != newMonthBudget){
        	    	    	currentRecord.setValue({
        	    	            fieldId: 'custrecord_ns_new_budget_'+m+'_residual',
        	    	            value: newMonthBudget - defaultEmpty(oldMonthBudget) + defaultEmpty(currentResidual),
        	    	            ignoreFieldChange: true,
        	    	        });
        	        	}
        			}	
        		}else if(type == 'create'){
        			for(var m = 1 ; m < 13 ; m++){
        	    		//Xåéó\éZécäz
        				var newMonthBudget = currentRecord.getValue({fieldId: 'custrecord_ns_new_budget_'+m});     
        				
        	        	if(!isEmpty(newMonthBudget)){
        	    	    	currentRecord.setValue({
        	    	            fieldId: 'custrecord_ns_new_budget_'+m+'_residual',
        	    	            value: newMonthBudget,
        	    	            ignoreFieldChange: true,
        	    	        });
        	        	}
        			}	
        		}
    		
        	//20230819 changed by zhou end
    		}catch(e){
    			log.debug("e",e.message);
    		}
    		//changed by song add 23030723 end
    		//CSVì±ì¸éû
    		log.debug('in CSV_IMPORT','')
    		//NS_é{çÙÉRÅ[Éh
            var divisionCode = currentRecord.getValue({
            	fieldId: 'custrecord_ns_new_ringi_division_code'
            })
    		
    		var ringiDivisionText = currentRecord.getValue({
    			fieldId: 'custrecord_ns_new_ringi_division_name'
            });//é{çÙãÊï™2
        	var nameText = divisionCode + " " + ringiDivisionText;
    		var oldRingiDivisionText = currentRecord.getValue({
    			fieldId: 'custpage_old_rs_name'
            });//NS_é{çÙãÊï™2å√Ç¢ÉeÉLÉXÉg
    		
    		
    		var changedFlag = 'F';//é{çÙÅié©ìÆçÃî‘ÅjÇ÷ÇÒÇ«Ç§ïœìÆÇ∑ÇÈÉtÉâÉO
    		
    		if(!isEmpty(nameText) && !isEmpty(oldRingiDivisionText) &&(nameText != oldRingiDivisionText)){
    			changedFlag = 'T';
    		}
    		var saveType =  currentRecord.getValue({fieldId: 'custpage_type' });
    		
    		var sameFlag = 'F';//ï€ë∂å„ÅAêVÇµÇ≠çÏê¨ÇµÇΩé{çÙÅié©ìÆçÃî‘ÅjñºÇ™èdï°ÇµÇƒÇ¢ÇÈÇ±Ç∆ÇämîFÇµÇ‹Ç∑
    		if(!isEmpty(nameText) && ((changedFlag == 'T' && saveType == 'edit') || (!isEmpty(nameText) && saveType != 'edit'))){
    			var sameCheckFilters = [];
    			var sameCheckColumns = [];
    			sameCheckFilters.push(["isinactive",'is','F']);//ñ≥å¯Ç»ÉfÅ[É^Çñ≥éã
    			sameCheckFilters.push("AND");
    			sameCheckFilters.push(["name","haskeywords",nameText]);
    			if(changedFlag == 'T'){
    				var rbId = currentRecord.getValue({
    		        	fieldId: 'custrecord_ns_new_rb_name_list'
    		        })//é{çÙÅié©ìÆçÃî‘Åj
    		        if(!isEmpty){
    		        	//åªç›ÇÃÉåÉRÅ[ÉhÇÃé{çÙÅié©ìÆçÃî‘ÅjÇèúäO
    		        	sameCheckFilters.push("AND");
    					sameCheckFilters.push(["internalid","noneof",rbId]);	
    		        }
    			}
    			var searchColumn =search.createColumn({
    				name : 'internalid',
    				label : 'ì‡ïîID'
    			}); 	
    			sameCheckColumns.push(searchColumn);
    			var type = 'customrecord_ns_ps_name_list';
    			var sameCheckSearch = createSearch(type, sameCheckFilters,sameCheckColumns);
    			if (sameCheckSearch && sameCheckSearch.length > 0) {
//    				alert('èdï°ÇµÇΩé{çÙÇ™Ç†ÇËÅAï€ë∂Ç≈Ç´Ç‹ÇπÇÒÇÃÇ≈ÅAÅué{çÙãÊï™2ÅvÇèCê≥ÇµÇƒÇ≠ÇæÇ≥Ç¢')
    				sameFlag = 'T';
    			}
    			
    		}
        	
    		
    		var haveFlag = 'F';//åªç›ÇÃó\éZÇ™é{çÙâ^óp‚gãcâÊñ Ç…ÇÊÇ¡ÇƒéQè∆Ç≥ÇÍÇƒÇ¢ÇÈÇ©Ç«Ç§Ç©ÇîªífÇ∑ÇÈ
    		
    		var recordId = currentRecord.id;
    		if(recordId){
    			var Filters = [];
    			var Columns = [];
    			Filters.push(["isinactive",'is','F']);//ñ≥å¯Ç»ÉfÅ[É^Çñ≥éã
    			Filters.push("AND");
    			Filters.push(["custrecord_ns_policy_budget_id","contains",recordId]);
    			
    			var policySearchColumn =search.createColumn({
    				name : 'internalid',
    				label : 'ì‡ïîID'
    			}); 	
    			Columns.push(policySearchColumn);
    			var type = 'customrecord_ns_policy_screen';
    			var policySearch = createSearch(type, Filters,Columns);
    			if (policySearch && policySearch.length >= 1) {
    				haveFlag = 'T';
    			}
    		}
    		
    		if(isinactiveFlag == false){
    			//ñ≥å¯ == F
    			log.debug('in')
    			var recordId = currentRecord.id;
        		
        		
    			
    			//UE ï€ë∂éûÅAèdï°É`ÉFÉbÉNÇí«â¡Ç∑ÇÈ
    		    //ïîèê / ínàÊ / Ãﬁ◊›ƒﬁ/ ëÂçÄñ⁄ / é{çÙ(åoîÔÉJÉeÉSÉä)
        		
        		//20230816 invalid add changed by zhou start
    	    	//zhou memo :ë™íËèdï°ÉfÅ[É^Çï€ë∂Ç∑ÇÈèÍçáÇÕÅAÅué{çÙÉRÅ[ÉhÅvÇÃÇ›ÇÉ`ÉFÉbÉNÇ∑ÇÈ.
    	    	//Asana link : https://app.asana.com/0/1205015233255169/1205274128751568
    			var ringiDivisionCode = currentRecord.getValue({
	            fieldId: 'custrecord_ns_new_ringi_division_code'
    			});//é{çÙÉRÅ[Éh 
    			var project = currentRecord.getValue({
    	            fieldId: 'custrecord_ns_new_big_project'
    	        });//ëÂçÄñ⁄
//    	    	var department = currentRecord.getValue({
//    	            fieldId: 'custrecord_ns_new_rb_dept'
//    	        });//ïîèê:ïîñÂñº
    	    	var ringiDivision = currentRecord.getValue({
    	            fieldId: 'custrecord_ns_new_ringi_division'
    	        });//è¨ãÊï™ : é{çÙ(åoîÔÉJÉeÉSÉä)
    	    	var ringiAccountNum = currentRecord.getValue({
    	            fieldId: 'custrecord_ns_new_account_num'
    	        });//NS_ä®íËâ»ñ⁄ÉRÅ[ÉhÅiCSVÉCÉìÉ|Å[Ég)
    	    	log.debug('ringiAccountNum set in   ',ringiAccountNum)
    	    	if(!isEmpty(ringiAccountNum)){
    	    		var acType = 'account';
        			var acFilters = [];
        				acFilters.push(["number","is",ringiAccountNum]);
        	    	var acColumns = [];
        			var acFileColumn = search.createColumn({
        				name : 'internalid',
        				label : 'ì‡ïîID'
        			});
        			var taxcodeColumn = search.createColumn({
        				name : 'custrecord_ns_taxcode',
        				label : 'NS_ê≈ã‡ÉRÅ[Éh'
        			});
        			acColumns.push(acFileColumn,taxcodeColumn);
        			var acSearch = createSearch( acType, acFilters,acColumns);
        			var accountId = '';
        			if (!isEmpty(acSearch)){
        				var acResult = acSearch[0];
   		    		 	accountId = acResult.getValue(acColumns[0]);//ä®íËâ»ñ⁄Id
   		    		 	var taxcode = acResult.getValue(acColumns[1]);//ê≈ã‡ÉRÅ[ÉhId
        			}
        			log.debug('accountId set in   ',accountId)
        			if(isEmpty(accountId)){
        				throw new error.create({
                            name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
                            message: 'åªç›ì¸óÕÇ≥ÇÍÇƒÇ¢ÇÈÅuNS_ä®íËâ»ñ⁄ÉRÅ[ÉhÅvÅFÅu'+ringiAccountNum+'ÅvÇÕëŒâûÇ∑ÇÈÅuä®íËâ»ñ⁄ÅvÇåüçıÇ≈Ç´Ç‹ÇπÇÒ',
                            notifyOff: false
                        });
        			}else{
        				currentRecord.setValue({
        	                fieldId : 'custrecord_ns_new_account',
        	                value : accountId,
                		});	
        				if(!isEmpty(taxcode)){
        					currentRecord.setValue({
            	                fieldId : 'custrecord_ns_new_rb_taxcode',
            	                value : taxcode,
                    		});
        				}
        			}
        			
    	    	}else{
    	    		throw new error.create({
                        name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
                        message: 'NS_ä®íËâ»ñ⁄ÉRÅ[ÉhÉCÉìÉ|Å[ÉgÇ…é∏îsÇµÇ‹ÇµÇΩ',
                        notifyOff: false
                    });
    	    	}
//    	    	var area = currentRecord.getValue({
//    	            fieldId: 'custrecord_ns_new_area'
//    	        });//NS_ínàÊ
//    	    	var bland = currentRecord.getValue({
//    	            fieldId: 'custrecord_ns_new_bland'
//    	        });//NS_ÉuÉâÉìÉh
    	    	//Create Search
    	    	var type = 'customrecord_ringi_budget_new';
    			var Filters = [];
    	    	//20230801 add by zhou start
    			var rgnameValue = currentRecord.getValue({
	                fieldId : 'custrecord_ns_new_ringi_division_name',
        		});	
//    			if(isEmpty(rgnameValue)){
				log.debug('rgnameValue set in')
				//CSVì±ì¸éûÅAé©ìÆÉXÉyÉãÅuCSV : é{çÙãÊï™2Åv  : ÅuNS_ëÂçÄñ⁄Åv+ ':' +ÅuNS_è¨ãÊï™Åv
//    			var rgname =  projectText + ' : ' + ringiDivisionText;//NS_è¨ãÊï™2 (CSV : é{çÙãÊï™2)
    			var rgname =  project + ' ' + ringiDivision;//NS_è¨ãÊï™2 (CSV é{çÙãÊï™2)//20230816 changed by zhou " : " => " " 
        		currentRecord.setValue({
	                fieldId : 'custrecord_ns_new_ringi_division_name',
	                value : rgname,
        		});	
//    			}
    			//20230801 add by zhou end
    	    	Filters.push(["isinactive",'is','F']);//ñ≥å¯Ç»ÉfÅ[É^Çñ≥éã
    			
    	    	
    	    	
//    	    	if(project){
//    	    		Filters.push("AND");
//    	    		Filters.push(["custrecord_ns_new_big_project",'anyof',project]);
//    	    	}
//    	    	if(department){
//    	    		Filters.push("AND");
//    	    		Filters.push(["custrecord_ns_new_rb_dept",'anyof',department]);
//    	    	}
//    	    	if(ringiDivision){
//    	    		Filters.push("AND");
//    	    		Filters.push(["custrecord_ns_new_ringi_division",'anyof',ringiDivision]);
//    	    	}
//    	    	if(area){
//    	    		Filters.push("AND");
//    	    		Filters.push(["custrecord_ns_new_area",'anyof',area]);
//    	    	}
//    	    	if(bland){
//    	    		Filters.push("AND");
//    	    		Filters.push(["custrecord_ns_new_bland",'anyof',bland]);
//    	    	}
    	    	if(ringiDivisionCode){
    	    		Filters.push("AND");
    	    		Filters.push(["custrecord_ns_new_ringi_division_code",'is',ringiDivisionCode]);
    	    	}//é{çÙÉRÅ[Éh
    	    	//20230816 invalid add changed by zhou end
    	    	//åªç›ÇÃÉåÉRÅ[ÉhÇèúäO
    	    	var recordId = currentRecord.id;
        		if(recordId){
        			Filters.push("AND");
    	    		Filters.push(["internalid","noneof",recordId]);
        		}
    	    	var Columns = [];
    			var fileColumn = search.createColumn({
    				name : 'internalid',
    				label : 'ì‡ïîID'
    			});
    			Columns.push(fileColumn);
    			var objSearch = createSearch( type, Filters,Columns);
    			if (objSearch && objSearch.length >= 1) {
    				log.debug(' >= 1','')
    				throw new error.create({
                        name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
//                      message: 'è’ìÀÇ™î≠ê∂ÇµÅAñ{ÉåÉRÅ[ÉhÇ∆ìØÇ∂ÅuïîñÂÅvÅAÅuëÂçÄñ⁄ÅvÅAÅuè¨ãÊï™ÅvÅAÅuNS_ínàÊÅvÅAÅuNS_ÉuÉâÉìÉhÅvÇÃÉåÉRÅ[ÉhÇ™ë∂ç›Ç∑ÇÈ',
                        message: 'è’ìÀÇ™î≠ê∂ÇµÅAñ{ÉåÉRÅ[ÉhÇ∆ìØÇ∂Åué{çÙÉRÅ[ÉhÅvÇÃÉåÉRÅ[ÉhÇ™ë∂ç›Ç∑ÇÈ',
                        notifyOff: false
                    });
    			}else{
    				if(recordId && haveFlag == 'T' && changedFlag == 'T'){
            			throw new error.create({
                            name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
                            message: 'åªç›ÇÃó\éZÇÕé{çÙâ^óp‚gãcâÊñ Ç…à¯ópÇ≥ÇÍÇƒÇ®ÇËÅAÅué{çÙãÊï™2ÅvÇÃèCê≥ÇÕïsâ¬',
                            notifyOff: false
                        });
        				return false;
        			}else{
        				if(sameFlag == 'T'){
        					throw new error.create({
                            name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
                            message: 'èdï°ÇµÇΩé{çÙÇ™Ç†ÇËÅAï€ë∂Ç≈Ç´Ç‹ÇπÇÒÇÃÇ≈ÅAÅué{çÙãÊï™2ÅvÇèCê≥ÇµÇƒÇ≠ÇæÇ≥Ç¢',
                            notifyOff: false
                        });
        					return false;
        				}
        			}
    				return true;
    			}
        	}else{
//        		//ñ≥å¯ == T
//        		var recordId = currentRecord.id;
//        		if(recordId){
//        			//ï“èWì±ì¸éû
//        			var Filters = [];
//        			var Columns = [];
//        			Filters.push(["isinactive",'is','F']);//ñ≥å¯Ç»ÉfÅ[É^Çñ≥éã
//        			Filters.push("AND");
//        			Filters.push(["custrecord_ns_policy_budget_id","contains",recordId]);//ñ≥å¯Ç»ÉfÅ[É^Çñ≥éã
//        			
//    				var policySearchColumn =search.createColumn({
//    					name : 'internalid',
//    					label : 'ì‡ïîID'
//    				}); 	
//    				Columns.push(policySearchColumn);
//    				var type = 'customrecord_ns_policy_screen';
//        			var policySearch = createSearch(type, Filters,Columns);
//        			if (policySearch && policySearch.length >= 1) {
//        				throw new error.create({
//                            name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
//                            message: 'ä÷òAÇ∑ÇÈÉgÉâÉìÉUÉNÉVÉáÉìÇ™Ç†ÇËÇ‹Ç∑ÇÃÇ≈ÅAçÌèúÇ≈Ç´Ç‹ÇπÇÒÅB',
//                            notifyOff: false
//                        });
//        			}else{
//        				return true;
//        			}
//        		}else{
//        			//êVãKì±ì¸éû
//        			return true;
//        		}

        		//ñ≥å¯ == T
        		var recordId = currentRecord.id;
        		if(recordId){
        			if(haveFlag == 'T'){
        				throw new error.create({
                          name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
                          message: 'ä÷òAÇ∑ÇÈÉgÉâÉìÉUÉNÉVÉáÉìÇ™Ç†ÇËÇ‹Ç∑ÇÃÇ≈ÅAçÌèúÇ≈Ç´Ç‹ÇπÇÒÅB',
                          notifyOff: false
                      });
        				return false;
        			}else{
        				if(sameFlag == 'T'){
        					throw new error.create({
        						name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
        						message: 'èdï°ÇµÇΩé{çÙÇ™Ç†ÇËÅAï€ë∂Ç≈Ç´Ç‹ÇπÇÒÇÃÇ≈ÅAÅué{çÙãÊï™2ÅvÇèCê≥ÇµÇƒÇ≠ÇæÇ≥Ç¢',
        						notifyOff: false
        					});
        					return false;
        				}else{
        					return true;
        				}
        			}
        			
        		}else{
        			//êVãK
        			if(sameFlag == 'T'){
    					throw new error.create({
    						name: 'CSVÉCÉìÉ|Å[ÉgàŸèÌ',
    						message: 'èdï°ÇµÇΩé{çÙÇ™Ç†ÇËÅAï€ë∂Ç≈Ç´Ç‹ÇπÇÒÇÃÇ≈ÅAÅué{çÙãÊï™2ÅvÇèCê≥ÇµÇƒÇ≠ÇæÇ≥Ç¢',
    						notifyOff: false
    					});
    					return false;
    				}else{
    					return true;
    				}
        		}
        	
        	}
    	}else{
    		try{
	    		var account = currentRecord.getValue({fieldId: 'custrecord_ns_new_account'}); 
	    		log.debug('account ' ,account)
	    		if(!isEmpty(account)){
	    			var taxcodeSearch = search.lookupFields({
						type: search.Type.ACCOUNT,
						id: account,
						columns: ['custrecord_ns_taxcode']
					});
	    			var taxcode = taxcodeSearch.custrecord_ns_taxcode;
	    			taxcode = taxcode[0].value;
	    			log.debug('taxcode ',taxcode)
	    			if(!isEmpty(taxcode) && taxcode != null && taxcode != 'null'){
						currentRecord.setValue({
	    	                fieldId : 'custrecord_ns_new_rb_taxcode',
	    	                value : taxcode,
	            		});
					}
	    		}
    		}catch(e){
    			
    		}
    	}
    }

    /**
     * Function definition to be triggered before record is loaded.
     *
     * @param {Object} scriptContext
     * @param {Record} scriptContext.newRecord - New record
     * @param {Record} scriptContext.oldRecord - Old record
     * @param {string} scriptContext.type - Trigger type
     * @Since 2015.2
     */
    function afterSubmit(scriptContext) {
    	//changed by song add 23030802 start
    	try{
        	var currentRecord = scriptContext.newRecord;
        	var recordId = currentRecord.id;
        	if(!isEmpty(recordId)){
			    var newFeatureRecord = record.load({
				    type: 'customrecord_ringi_budget_new',
				    id: recordId,
				    isDynamic: true
				});
			    //å≈íËéëéYéÊìæã‡äz
        		var budgetAmount = Number(newFeatureRecord.getValue({fieldId: 'custrecord_ns_new_acquisition_amount'}));
        		if(!isNull(budgetAmount)){
        			if(budgetAmount > 0){ //å∏âøèûãp
        				newFeatureRecord.setValue({
        					fieldId: 'custrecord_ns_new_policy_list',
        					value: 3,
        				});	
        			}else if(budgetAmount <= 0){ //í èÌ
        				newFeatureRecord.setValue({
        					fieldId: 'custrecord_ns_new_policy_list',
        					value: 1,
        				});	
        			}
        		}
        		//çÌèúÉtÉâÉO
        		var deleteFlag = newFeatureRecord.getValue({fieldId: 'isinactive'})
        		//NS_é{çÙÉRÅ[Éh
        		var divisionCode = newFeatureRecord.getValue({fieldId: 'custrecord_ns_new_ringi_division_code'})
        		//NS_è¨ãÊï™2
        		var divisionName = newFeatureRecord.getValue({fieldId: 'custrecord_ns_new_ringi_division_name'})
        		//NS_é{çÙÉRÅ[Éh + NS_è¨ãÊï™2
        		var listrbName = divisionCode + " " + divisionName;
        		//NS_é{çÙÅiîÒï\é¶Åj
        		var listrbRecord = newFeatureRecord.getValue({fieldId: 'custrecord_ns_new_rb_name_list'})
        		if(!isEmpty(listrbName)){
            		newFeatureRecord.setValue({  //NS_ÉäÉXÉgópï\é¶ñºÅiîÒï\é¶Åj
    					fieldId: 'custrecord_ns_new_rb_name',
    					value: listrbName,
            		});	
            		if(!isEmpty(listrbRecord)){
            			 record.submitFields({
            				    type: 'customrecord_ns_ps_name_list',
            				    id: listrbRecord,
            				    values: {
            				        'name': listrbName
            				    }
            			});
            			 record.submitFields({
         				    type: 'customrecord_ns_ps_name_list',
         				    id: listrbRecord,
         				    values: {
         				        'isinactive': deleteFlag
         				    }
         			});
            		}else{
            			//çÏê¨ NS_é{çÙ
            			var objRecord = record.create({
            				type: 'customrecord_ns_ps_name_list',
            				isDynamic: true,
            			});
            			objRecord.setValue({  //ñºëO
        					fieldId: 'name',
        					value: listrbName,
                		});	
            			objRecord.setValue({  //NS_ó\éZ
        					fieldId: 'custrecord_ns_ringi_division_list',
        					value: recordId,
                		});	   
            			objRecord.setValue({  // ñ≥å¯
        					fieldId: 'isinactive',
        					value: deleteFlag,
                		});
            			var objRecordId = objRecord.save();           			
            			if(!isEmpty(objRecordId)){ //NS_é{çÙÅiîÒï\é¶Åj
                    		newFeatureRecord.setValue({  //NS_ÉäÉXÉgópï\é¶ñºÅiîÒï\é¶Åj
            					fieldId: 'custrecord_ns_new_rb_name_list',
            					value: objRecordId,
                    		});	
            			}
            		}
        		}
    			newFeatureRecord.save();
        	}
		}catch(e){
			log.debug("e",e.message);
		}
		//changed by song add 23030802 end
    }
    /**
     * åüçıã§í ÉÅÉ\ÉbÉh
     */
    function createSearch(searchType, searchFilters, searchColumns) {

        var resultList = [];
        var resultIndex = 0;
        var resultStep = 1000;
        var objSearch = search.create({
            type : searchType,
            filters : searchFilters,
            columns : searchColumns
        });
        var objResultSet = objSearch.run();
        do {
            var results = objResultSet.getRange({
                start : resultIndex,
                end : resultIndex + resultStep
            });

            if (results.length > 0) {
                resultList = resultList.concat(results);
                resultIndex = resultIndex + resultStep;
            }
        } while (results.length == 1000);
        return resultList;
    }
    
	function isNull(valueStr){
		return (valueStr === null || valueStr === '' || valueStr === undefined);
	}
    function isEmpty(obj) {
    	if (obj == undefined || obj == null || obj == '') {
    		return true;
    	}
    	if (obj.length && obj.length > 0) {
    		return false;
    	}
    	if (obj.length === 0) {
    		return true;
    	}
    	for ( var key in obj) {
    		if (hasOwnProperty.call(obj, key)) {
    			return false;
    		}
    	}
    	if (typeof (obj) == 'boolean') {
    		return false;
    	}
    	if (typeof (obj) == 'number') {
    		return false;
    	}
    	return true;
    }
	function defaultEmpty(obj){
		if (obj === undefined || obj == null || obj === '') {
    		return 0;
    	}
    	return obj;
	}
    return {
        beforeLoad: beforeLoad,
        beforeSubmit: beforeSubmit,
        afterSubmit: afterSubmit
    };
    
});
